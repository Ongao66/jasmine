name: Build ARM64 AppImage on Ubuntu

on:
  workflow_dispatch:

env:
  RUST_TOOLCHAIN: nightly-2024-12-02
  FLUTTER_VERSION: '3.7.3'

jobs:
  build_linux_arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            file \
            git \
            libfuse2 \
            libgl1-mesa-dev \
            libgtk-3-dev \
            liblzma-dev \
            ninja-build \
            pkg-config \
            unzip \
            xz-utils \
            zip \
            clang \
            cmake \
            libssl-dev

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          target: aarch64-unknown-linux-gnu
          override: true

      - name: Install AppImage tools
        run: |
          curl -LO https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool-aarch64.AppImage
          sudo mv appimagetool-aarch64.AppImage /usr/local/bin/appimagetool

      - name: Install Flutter ARM64 manually
        run: |
          # 下载官方 Flutter SDK
          wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
          tar xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
          echo "${GITHUB_WORKSPACE}/flutter/bin" >> $GITHUB_PATH
          
          # 配置 Flutter
          flutter config --no-analytics
          flutter precache
          flutter doctor

      - name: Build Rust library
        run: |
          cd native/jmbackend
          cargo build --release --target=aarch64-unknown-linux-gnu
          cp target/aarch64-unknown-linux-gnu/release/librust.a ../../linux/
          cbindgen src/lib.rs -l c++ > ../../linux/rust.h
          cd ../..

      - name: Build Flutter application
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          
          # 显式指定目标平台
          flutter build linux --release --target-platform linux-arm64
          
          # 准备 AppImage
          mv build/linux/arm64/release/bundle/jasmine build/linux/arm64/release/bundle/AppRun
          chmod +x build/linux/arm64/release/bundle/AppRun
          cp linux/appimage/* build/linux/arm64/release/bundle/
          
          # 创建 AppImage
          appimagetool build/linux/arm64/release/bundle/
          mv Jasmine*.AppImage jasmine-arm64.AppImage

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jasmine-arm64.AppImage
          path: jasmine-arm64.AppImage
          retention-days: 3
